---
title: 在 Azure 应用程序网关上启用端到端 TLS
description: 本文概述了应用程序网关端到端 TLS 支持。
services: application-gateway
author: amsriva
ms.service: application-gateway
ms.topic: article
ms.date: 3/19/2019
ms.author: victorh
ms.openlocfilehash: 286c9329be38055808571d8d32c724d27a61cbf3
ms.sourcegitcommit: c535228f0b77eb7592697556b23c4e436ec29f96
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/06/2020
ms.locfileid: "82855871"
---
# <a name="overview-of-tls-termination-and-end-to-end-tls-with-application-gateway"></a>TLS 终止和端到端 TLS 与应用程序网关的概述

传输层安全性（TLS）以前称为安全套接字层（SSL）是一种用于在 web 服务器和浏览器之间建立加密链接的标准安全技术。 此链接可确保在 Web 服务器与浏览器之间传递的所有数据都会得到保密和加密。 应用程序网关支持网关和端到端 TLS 加密中的 TLS 终止。

## <a name="tls-termination"></a>TLS 终止

应用程序网关支持在网关上进行 TLS 终止，在这种情况下，流量通常会以未加密形式发送到后端 在应用程序网关上执行 TLS 终止有多种优点：

- **提高了性能**-执行 TLS 解密时最大的性能影响是初始握手。 若要提高性能，执行解密的服务器会缓存 TLS 会话 Id 并管理 TLS 会话票证。 如果此操作是在应用程序网关上执行的，则来自同一个客户端的所有请求都可以使用缓存的值。 如果此操作是在后端服务器上执行的，则每当客户端的请求转到另一台服务器时，客户端都必须重新进行身份验证。 使用 TLS 票证有助于缓解此问题，但并非所有客户端都支持 TLS 票证，并且配置和管理这些票证可能有难度。
- **更好地利用后端服务器**– SSL/TLS 处理会消耗大量 CPU，并且随着密钥大小的增加，变得越来越大。 从后端服务器中消除此任务可使它们专注于以最有效的方式提供内容。
- **智能路由**–通过解密流量，应用程序网关可以访问请求内容（如标头、URI 等），并可以使用此数据来路由请求。
- **证书管理**–只需在应用程序网关上购买和安装证书，而不是所有后端服务器。 这可以节省时间和开支。

若要配置 TLS 终止，需要将 TLS/SSL 证书添加到侦听器，以使应用程序网关能够根据 TLS/SSL 协议规范派生对称密钥。 然后，可以使用该对称密钥来加密和解密发送到网关的流量。 TLS/SSL 证书需要采用个人信息交换（PFX）格式。 此文件格式适用于导出私钥，后者是应用程序网关对流量进行加解密所必需的。

> [!IMPORTANT] 
> 请注意，侦听器上的证书需要上传整个证书链。 


> [!NOTE] 
>
> 应用程序网关不会提供任何用于创建新证书，或者将证书请求发送到证书颁发机构的功能。

要使 TLS 连接正常运行，需要确保 TLS/SSL 证书满足以下条件：

- 当前日期和时间处于证书上的“Valid from”（有效起始日期）和“Valid to”（有效结束日期）日期范围内。
- 证书的“公用名”(CN) 与请求中的主机头匹配。 例如，如果客户端向 `https://www.contoso.com/` 发出请求，则 CN 必须为 `www.contoso.com`。

### <a name="certificates-supported-for-tls-termination"></a>TLS 终止支持的证书

应用程序网关支持以下类型的证书：

- CA （证书颁发机构）证书： CA 证书是由证书颁发机构（CA）颁发的数字证书
- EV （扩展验证）证书： EV 证书是符合行业标准证书准则的证书。 这会将浏览器定位器栏变为绿色，并同时发布公司名称。
- 通配符证书：此证书支持基于 *. site.com 的任意数量的子域，其中子域将替换 *。 但是，它不支持 site.com，因此，如果用户在不键入前导“www”的情况下访问你的网站，则通配符证书不会反映这一点。
- 自签名证书：客户端浏览器不信任这些证书，并将向用户警告虚拟服务的证书不是信任链的一部分。 自签名证书适合用于测试，或者管理员会在其中控制客户端并且可以安全绕过浏览器安全警报的环境。 切勿将自签名证书用于生产工作负荷。

有关详细信息，请参阅[配置应用程序网关的 TLS 终止](https://docs.microsoft.com/azure/application-gateway/create-ssl-portal)。

### <a name="size-of-the-certificate"></a>证书大小
检查 "[应用程序网关限制](https://docs.microsoft.com/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits)" 部分，了解支持的最大 TLS/SSL 证书大小。

## <a name="end-to-end-tls-encryption"></a>端到端 TLS 加密

某些客户可能不希望与后端服务器进行未加密的通信。 这可能是因为安全要求、符合性要求，或者应用程序可能仅接受安全连接。 对于此类应用程序，应用程序网关支持端到端 TLS 加密。

通过端到端 TLS，可以安全地将敏感数据传输到后端，同时仍可利用应用程序网关提供的第7层负载均衡功能的好处。 部分功能包括：基于 Cookie 的会话相关性、基于 URL 的路由、基于站点的路由支持，或注入 X-Forwarded-* 标头。

当配置为端到端 TLS 通信模式时，应用程序网关会在网关上终止 TLS 会话，并解密用户流量。 然后，它会应用配置的规则，以选择要将流量路由到的适当后端池实例。 然后，应用程序网关启动到后端服务器的新 TLS 连接，并使用后端服务器的公钥证书重新加密数据，然后再将请求传输到后端。 来自 Web 服务器的任何响应都会经历相同的过程返回最终用户。 启用端到端 TLS，方法是将[后端 HTTP 设置](https://docs.microsoft.com/azure/application-gateway/configuration-overview#http-settings)中的协议设置设置为 HTTPS，然后将应用到后端池。

TLS 策略适用于前端和后端流量。 在前端上，应用程序网关充当服务器并强制实施该策略。 在后端，应用程序网关充当客户端，并在 TLS 握手期间将协议/密码信息作为首选项发送。

应用程序网关只会与下面所述的后端实例通信：已将其证书加入应用程序网关的允许列表，或者其证书已由已知的 CA 颁发机构签名，并且证书 CN 与 HTTP 后端设置中的主机名匹配。 这些实例包括受信任的 Azure 服务，例如 Azure 应用服务 Web 应用和 Azure API 管理。

如果后端池中成员的证书未由已知 CA 颁发机构进行签名，则必须使用证书配置后端池中的每个实例，以允许安全通信。 添加证书后，可确保应用程序网关仅与已知后端实例通信。 从而进一步保护端到端通信。

> [!NOTE] 
>
> Azure 应用服务 Web 应用和 Azure API 管理等受信任的 Azure 服务不需要身份验证证书设置。

> [!NOTE] 
>
> 添加到**后端 HTTP 设置**的证书用于对后端服务器进行身份验证的证书可能与在应用程序网关上添加到用于 TLS 终止的**侦听器**的证书相同，或者不同于增强的安全性。

![端到端 tls 方案][1]

在此示例中，使用 TLS 1.2 的请求使用端到端 TLS 路由到 Pool1 中的后端服务器。

## <a name="end-to-end-tls-and-whitelisting-of-certificates"></a>证书的端到端 TLS 和允许列表

应用程序网关只会与已知的后端实例通信，这些实例已将其证书加入应用程序网关的允许列表。 要启用证书允许列表，必须将后端服务器证书的公钥上传到应用程序网关（而不是根证书）。 然后仅允许连接到已知且加入允许列表的后端。 剩余的后端会导致网关错误。 自签名证书仅用于测试目的，不建议用于生产工作负荷。 如前面的步骤中所述，此类证书必须加入应用程序网关的允许列表，才可以使用。

> [!NOTE]
> Azure 应用服务等受信任的 Azure 服务不需要身份验证证书设置。

## <a name="end-to-end-tls-with-the-v2-sku"></a>带有 v2 SKU 的端到端 TLS

身份验证证书已弃用，并由应用程序网关 v2 SKU 中的受信任的根证书替换。 它们的功能与身份验证证书类似，但有一些主要区别：

- 由已知 CA 颁发机构签名的证书，其 CN 与 HTTP 后端设置中的主机名匹配，无需任何额外步骤即可使用端到端 TLS。 

   例如，如果后端证书由知名 CA 颁发并具有 contoso.com 的 CN，并且后端 http 设置的主机字段也设置为 contoso.com，则不需要其他步骤。 可以将后端 http 设置协议设置为 HTTPS，运行状况探测和数据路径都将启用 TLS。 如果使用 Azure App Service 或其他 Azure web 服务作为后端，则它们也是隐式信任的，并且对于端到端 TLS，无需执行其他步骤。
   
> [!NOTE] 
>
> 为了使 TLS/SSL 证书受信任，后端服务器的证书必须由应用程序网关的受信任存储区中包含的 CA 颁发。如果证书不是由受信任的 CA 颁发的，则应用程序网关将检查发证 CA 的证书是否由受信任的 CA 颁发，依此类推，直到找到了受信任的 CA （此时将建立受信任的安全连接），或找不到受信任的 CA （此时，应用程序网关会将后端标记为不正常）。 因此，建议后端服务器证书同时包含根和中间 Ca。

- 如果证书是自签名证书，或者是由未知中介签署的，则若要在 v2 SKU 中启用端到端 TLS，则必须定义受信任的根证书。 应用程序网关仅与符合以下条件的后端进行通信：后端的服务器证书的根证书与池关联的后端 http 设置中的受信任根证书列表之一匹配。

> [!NOTE] 
>
> 自签名证书必须是证书链的一部分。 V2 SKU 不支持无链的单个自签名证书。

- 除了根证书匹配外，应用程序网关还会验证后端 http 设置中指定的主机设置是否与后端服务器的 TLS/SSL 证书显示的公用名（CN）匹配。 尝试与后端建立 TLS 连接时，应用程序网关会将服务器名称指示（SNI）扩展设置为后端 http 设置中指定的主机。
- 如果在后端 http 设置中选择了 "**从后端地址中选取主机名**" 而不是 "主机" 字段，则 SNI 标头始终设置为后端池 FQDN，而后端服务器 TLS/SSL 证书上的 CN 必须与其 FQDN 匹配。 此方案不支持具有 IP 的后端池成员。
- 根证书是来自后端服务器证书的 base64 编码的根证书。

## <a name="next-steps"></a>后续步骤

了解端到端 TLS 后，请参阅[使用应用程序网关通过 PowerShell 配置端到端 tls](application-gateway-end-to-end-ssl-powershell.md) ，使用端到端 tls 创建应用程序网关。

<!--Image references-->

[1]: ./media/ssl-overview/scenario.png
