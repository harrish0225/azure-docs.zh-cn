---
title: 自动缩放和区域冗余应用程序网关 v2
description: 本文介绍 Azure 应用程序 Standard_v2 和 WAF_v2 SKU，其中包括自动缩放和区域冗余功能。
services: application-gateway
author: vhorne
ms.service: application-gateway
ms.topic: article
ms.date: 03/24/2020
ms.author: victorh
ms.custom: fasttrack-edit
ms.openlocfilehash: 74af3d14512018abc216b288a27dc54ed806d8c9
ms.sourcegitcommit: a8ee9717531050115916dfe427f84bd531a92341
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 05/12/2020
ms.locfileid: "83125224"
---
# <a name="autoscaling-and-zone-redundant-application-gateway-v2"></a>自动缩放和区域冗余应用程序网关 v2 

应用程序网关和 Web 应用程序防火墙 (WAF) 在 Standard_v2 和 WAF_v2 SKU 中也可用。 v2 SKU 提供性能增强，并添加了对自动缩放、区域冗余等关键新功能以及静态 VIP 的支持。 Standard 和 WAF SKU 中的现有功能在新的 v2 SKU 中仍受支持，不过存在几种例外情况，具体请参阅[比较](#differences-with-v1-sku)部分。

新的 v2 SKU 包括以下增强：

- **自动缩放**：凭借自动缩放 SKU，应用程序网关或 WAF 部署可根据变化中的流量负载模式增加或减少。 自动缩放还无需在预配期间要求选择部署大小或实例计数。 此 SKU 提供真正的弹性。 在 Standard_v2 和 WAF_v2 SKU 中，应用程序网关可同时在固定容量（自动缩放已禁用）和已启用自动缩放的模式下运行。 固定容量模式对具有一致性和可预测工作负荷的方案非常有用。 应用程序流量会出现差异的应用程序可以受益于自动缩放模式。
- **区域冗余**：应用程序网关或 WAF 部署可跨多个可用性区域，因此不需要使用流量管理器在每个区域中单独预配应用程序网关实例。 可以选择一个或多个区域来部署应用程序网关实例，以便更灵活地应对区域故障。 应用程序的后端池可以通过类似方式分布在多个可用性区域中。

  仅当 Azure 区域可用时，区域冗余才可用。 在其他区域中，支持所有其他功能。 有关详细信息，请参阅[Azure 中的区域和可用性区域](../availability-zones/az-overview.md)
- **静态 VIP**：目前只有应用程序网关 v2 SKU 支持静态 VIP 类型。 这可以确保与应用程序网关关联的 VIP 在部署的整个生命周期内不会更改，即使发生重启。  v1 中没有静态 VIP，因此必须使用应用程序网关 URL（而不是 IP 地址）通过应用程序网关将域名路由到应用服务。
- **标头重写**：应用程序网关允许使用 v2 SKU 添加、删除或更新 HTTP 请求和响应标头。 有关详细信息，请参阅[重写应用程序网关的 HTTP 标头](rewrite-http-headers.md)。
- **Key Vault 集成**：应用程序网关 v2 支持与 Key Vault 集成，以获取要附加到支持 HTTPS 的侦听器的服务器证书。 有关详细信息，请参阅[使用 Key Vault 证书实现 TLS 终止](key-vault-certs.md)。
- **Azure Kubernetes 服务入口控制器**：借助应用程序网关 v2 入口控制器，可将 Azure 应用程序网关用作 Azure Kubernetes 服务 (AKS)（称为 AKS 群集）的入口。 有关详细信息，请参阅[什么是应用程序网关入口控制器？](ingress-controller-overview.md)。
- **性能增强**：v2 SKU 提供的 TLS 卸载性能比 Standard/WAF SKU 高达 5 倍。
- **更快的部署和更新速度** v2 SKU 的部署和更新速度比 Standard/WAF SKU 更快。 这还包括了 WAF 配置更改。

![](./media/application-gateway-autoscaling-zone-redundant/application-gateway-autoscaling-zone-redundant.png)

## <a name="supported-regions"></a>支持的区域

Standard_v2 和 WAF_v2 SKU 在以下区域提供：美国中北部、美国中南部、美国西部、美国西部2、美国东部、美国东部2、美国中部、北欧、西欧、东南亚、法国中部、英国西部、日本东部、日本西部、澳大利亚东部、澳大利亚东南部、巴西南部、加拿大中部、加拿大东部、东亚、韩国中部、韩国南部、英国南部、印度中部、印度西部、印度南部。

## <a name="pricing"></a>定价

使用 v2 SKU 时，定价模型将由消耗量驱动，而不再与实例计数或大小相关。 v2 SKU 定价包括两个部分：

- **固定价格** - 这是预配一个 Standard_v2 或 WAF_v2 网关的价格，按小时（或小时的一部分）计收。 请注意，0 个额外的最小实例仍可确保服务的高可用性，该服务始终包含在固定价格中。
- **容量单位价格** - 这是在固定价格的基础上按消耗量计收的费用。 容量单位费用也按每小时或小时的一部分计算的。 容量单位有三个维度 - 计算单位、持久连接和吞吐量。 计算单位用于度量消耗的处理器容量。 影响计算单位的因素包括每秒 TLS 连接数、URL 重写计算和 WAF 规则处理。 持久连接用于度量在给定计费间隔内与应用程序网关建立的 TCP 连接数。 吞吐量是系统在给定计费间隔内平均每秒处理的兆位数。  对于超过预留实例计数的任何内容，均按容量单位级别进行计费。

每个容量单位最多包括：1 个计算单位，或 2500 个持久连接，或 2.22-Mbps 吞吐量。

计算单位指导：

- **Standard_v2** - 每个计算单位每秒可以使用 RSA 2048 位密钥 TLS 证书处理大约 50 个连接。
- **WAF_v2** - 如果流量混合率为 70-30%，且 70% 的请求小于 2 KB GET/POST，剩余请求的计算量更高，则每个计算单位可支持每秒大约 10 个并发请求。 目前，WAF 性能不受响应大小的影响。

> [!NOTE]
> 每个实例目前支持大约 10 个容量单位。
> 计算单位可处理的请求数取决于多种条件，例如 TLS 证书密钥大小、密钥交换算法、标头重写次数以及 WAF 传入请求大小。 我们建议执行应用程序测试，以确定每个计算单位的请求速率。 在开始计费之前，我们会以指标的形式提供容量单位和计算单位。

下表显示了示例价格，仅用于说明目的。

**美国东部价格**：

|              SKU 名称                             | 固定价格（$ 美元/小时）  | 容量单位价格（$/CU-hr）   |
| ------------------------------------------------- | ------------------- | ------------------------------- |
| Standard_v2                                       |    0.20             | 0.0080                          |
| WAF_v2                                            |    0.36             | 0.0144                          |

有关详细定价信息，请参阅[定价页](https://azure.microsoft.com/pricing/details/application-gateway/)。 

**示例 1**

预配应用程序网关 Standard_v2，无需在手动缩放模式下自动缩放，且具有固定容量的五个实例。

固定价格 = 744 （小时） * $0.20 = $148。8 <br>
容量单位 = 744 （小时） * 每个实例10个容量单位 * 5 个实例 * $0.008 每个容量单位小时 = $297。6

总价 = $148.8 + $297.6 = $446。4

**示例 2**

应用程序网关 standard_v2 预配了一个月，最小实例数为零，在这段时间内它每秒接收了25个新的 TLS 连接，平均为 8.88-Mbps 的数据传输。 假设连接寿命较短，则价格将为：

固定价格 = 744 （小时） * $0.20 = $148。8

容量单位价格 = 744 （小时） * 最大值（25/50 的计算单元数/秒，8.88/2.22 容量单位） * $0.008 = 744 * 4 * 0.008 = $23.81

总价 = $ 148.8 + 23.81 = $172.61

如您所见，只对四个容量单元计费，而不是针对整个实例计费。 

> [!NOTE]
> Max 函数返回一对值中的最大值。


**示例 3**

应用程序网关 standard_v2 预配了一个月，其中至少有五个实例。 假设没有流量，并且连接的生存期很短，则价格将为：

固定价格 = 744 （小时） * $0.20 = $148。8

容量单位价格 = 744 （小时） * 最大值（0/50 的计算单元数/秒，0/2.22 容量单位） * $0.008 = 744 * 50 * 0.008 = $297.60

总价 = $ 148.80 + 297.60 = $446。4

在这种情况下，即使没有流量，也只需支付5个实例的全部费用。

**示例4**

应用程序网关 standard_v2 预配了一个月，其中至少有五个实例，但这一次平均为 125-mbps 的数据传输，每秒25个 TLS 连接。 假设没有流量，并且连接的生存期很短，则价格将为：

固定价格 = 744 （小时） * $0.20 = $148。8

容量单位价格 = 744 （小时） * 最大（25/50 个用于连接的计算单元/秒，125/2.22 容量单位用于吞吐量） * $0.008 = 744 * 57 * 0.008 = $339.26

总价 = $ 148.80 + 339.26 = $488.06

在这种情况下，系统会对完整的五个实例进行计费，并向你收取7个容量单位（实例为7/10）。  

**示例 5**

应用程序网关 WAF_v2 预配了一个月。 在此期间，它将接收25个新的 TLS connections/sec，平均为 8.88-Mbps 数据传输，每秒执行80个请求。 假设连接的生存期很短，并且应用程序的计算单元计算支持每个计算单元10个 RPS，则价格将为：

固定价格 = 744 （小时） * $0.36 = $267.84

容量单位价格 = 744 （小时） * 最大值（计算单位上限（25/50 for connections/sec，80/10 WAF RPS），8.88/2.22 容量单位为吞吐量） * $0.0144 = 744 * 8 * 0.0144 = $85.71

总价 = $267.84 + $85.71 = $353.55

> [!NOTE]
> Max 函数返回一对值中的最大值。

## <a name="scaling-application-gateway-and-waf-v2"></a>缩放应用程序网关和 WAF v2

可将应用程序网关和 WAF 配置为以两种模式进行缩放：

- **自动缩放** - 启用自动缩放后，应用程序网关和 WAF v2 SKU 将会根据应用程序流量要求进行纵向缩放。 此模式为应用程序提供更好的弹性，使你无需猜测应用程序网关大小或实例计数。 使用此模式还可以不要求网关为预期的最大流量负载以最大预配容量运行，从而节省成本。 必须指定最小和（可选）最大实例计数。 最小容量确保应用程序网关和 WAF v2 不会低于指定的最小实例计数，即使在没有流量时也是如此。 每个实例大致相当于10个额外的保留容量单位。 0 表示没有预留容量，本质上是纯自动缩放。 你还可以选择性地指定最大实例计数，这样可以确保应用程序网关不会扩展到超出指定数量的实例。 你只需为网关提供的流量计费。 实例计数的范围为 0 到 125。 如果未指定，最大实例计数的默认值为 20。
- **手动** - 也可以选择“手动”模式，在这种情况下，网关不会自动缩放。 在此模式下，如果流量超过了应用程序网关或 WAF 可以处理的流量，可能会导致流量丢失。 使用手动模式时，必须指定实例计数。 实例计数可以在 1 到 125 的范围内变化。

## <a name="autoscaling-and-high-availability"></a>自动缩放和高可用性

Azure 应用程序网关始终以高度可用的方式进行部署。 此服务由创建为已配置的多个实例（如果禁用了自动缩放）或应用程序加载（如果启用了自动缩放）所要求的实例组成。 请注意，从用户的角度来看，您不必查看各个实例，只需在应用程序网关服务中查看。 如果某个实例出现问题并停止运行，Azure 应用程序网关将以透明方式创建一个新的实例。

请注意，即使配置最小值为零的自动缩放，服务仍将具有高可用性，这始终包含在固定价格中。

但是，创建新的实例可能需要一些时间（大约6到7分钟）。 因此，如果不想应对此停机时间，则可以配置最小实例计数2，理想情况下使用可用性区域支持。 这样一来，在正常情况下，你的 Azure 应用程序网关中将至少有两个实例，因此，如果其中一个实例遇到问题，则在创建新实例的过程中，其他实例将尝试处理流量。 请注意，Azure 应用程序网关实例可支持大约10个容量单位，因此，根据通常需要的流量，你可能需要将最小实例自动缩放设置配置为大于2的值。

## <a name="feature-comparison-between-v1-sku-and-v2-sku"></a>v1 SKU 与 v2 SKU 之间的功能比较

下表比较了每个 SKU 提供的功能。

|                                                   | v1 SKU   | v2 SKU   |
| ------------------------------------------------- | -------- | -------- |
| 自动缩放                                       |          | &#x2713; |
| 区域冗余                                   |          | &#x2713; |
| 静态 VIP                                        |          | &#x2713; |
| Azure Kubernetes 服务 (AKS) 入口控制器 |          | &#x2713; |
| Azure Key Vault 集成                       |          | &#x2713; |
| 重写 HTTP(S) 标头                           |          | &#x2713; |
| 基于 URL 的路由                                 | &#x2713; | &#x2713; |
| 多站点托管                             | &#x2713; | &#x2713; |
| 流量重定向                               | &#x2713; | &#x2713; |
| Web 应用程序防火墙 (WAF)                    | &#x2713; | &#x2713; |
| WAF 自定义规则                                  |          | &#x2713; |
| 传输层安全性 (TLS)/安全套接字层 (SSL) 终止            | &#x2713; | &#x2713; |
| 端到端 TLS 加密                         | &#x2713; | &#x2713; |
| 会话相关性                                  | &#x2713; | &#x2713; |
| 自定义错误页                                | &#x2713; | &#x2713; |
| WebSocket 支持                                 | &#x2713; | &#x2713; |
| HTTP/2 支持                                    | &#x2713; | &#x2713; |
| 连接清空                               | &#x2713; | &#x2713; |

> [!NOTE]
> 自动缩放 v2 SKU 现在支持使用[默认的运行状况探测](application-gateway-probe-overview.md#default-health-probe)自动监视后端池中所有资源的运行状况，并突出显示那些被视为不正常的后端成员。 对于不使用任何自定义探测配置的后端，系统会自动配置默认的运行状况探测。 有关详细信息，请参阅[应用程序网关中的运行状况探测](application-gateway-probe-overview.md)。

## <a name="differences-with-v1-sku"></a>与 v1 SKU 的差异

|差异|详细信息|
|--|--|
|身份验证证书|不支持。<br>有关详细信息，请参阅[应用程序网关的端到端 TLS 概述](ssl-overview.md#end-to-end-tls-with-the-v2-sku)。|
|在同一子网上混合使用 Standard_v2 和标准应用程序网关|不支持|
|应用程序网关子网上的用户定义路由 (UDR)|支持（特定方案）。 处于预览状态。<br> 有关支持的方案的详细信息，请参阅[应用程序网关配置概述](configuration-overview.md#user-defined-routes-supported-on-the-application-gateway-subnet)。|
|入站端口范围的 NSG| 对于 Standard_v2 SKU，为 - 65200 到 65535<br>对于标准 SKU，为 - 65503 到 65534<br>有关详细信息，请参阅[常见问题解答](application-gateway-faq.md#are-network-security-groups-supported-on-the-application-gateway-subnet)。|
|Azure 诊断中的性能日志|不支持。<br>应当使用 Azure 指标。|
|计费|我们已安排在 2019 年 7 月 1 日开始计费。|
|FIPS 模式|目前不支持。|
|“仅 ILB”模式|目前不支持。 同时支持公共和 ILB 模式。|
|网络观察程序集成|不支持。|
|Azure 安全中心集成|尚不可用。

## <a name="migrate-from-v1-to-v2"></a>从 v1 迁移到 v2

PowerShell 库中提供了一个 Azure PowerShell 脚本，以帮助你从 v1 应用程序网关/WAF 迁移到 v2 自动缩放 SKU。 此脚本可帮助你从 v1 网关复制配置。 流量迁移仍由你负责。 有关详细信息，请参阅[将 Azure 应用程序网关从 v1 迁移到 v2](migrate-v1-v2.md)。

## <a name="next-steps"></a>后续步骤

- [快速入门：使用 Azure 应用程序网关定向 Web 流量 - Azure 门户](quick-create-portal.md)
- [使用 Azure PowerShell 创建具有预留虚拟 IP 地址的自动缩放区域冗余应用程序网关](tutorial-autoscale-ps.md)
- 了解有关[应用程序网关](overview.md)的详细信息。
- 了解有关 [Azure 防火墙](../firewall/overview.md)的详细信息。
